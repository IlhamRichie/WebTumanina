{% extends 'base.html' %}
{% block content %}
<h1 style="text-align: center; font-family: Arial, sans-serif;">Manage Discussions</h1>

<!-- Button to open Add Modal -->
<button onclick="openModal('add')"
    style="display: inline-block; margin: 10px 0; padding: 10px 15px; background-color: #4CAF50; color: white; text-decoration: none; border-radius: 5px;">
    Add New Discussion
</button>

<table style="width: 100%; border-collapse: collapse;">
    <thead>
        <tr style="background-color: #f2f2f2;">
            <th style="border: 1px solid #ddd; padding: 8px;">ID</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Title</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Content</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Created By</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Username</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Created At</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for discussion in discussions %}
        <tr>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ discussion.id }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ discussion.title }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ discussion.content }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ discussion.created_by }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ discussion.user_apk_username }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">{{ discussion.created_at }}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">
                <button
                    onclick="openModal('edit', {{ discussion.id }}, {{ discussion.title|tojson }}, {{ discussion.content|tojson }})"
                    style="margin-right: 10px; color: #2196F3;">
                    Edit
                </button>
                <button onclick="handleDelete({{ discussion.id }})"
                    style="background-color: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">
                    Delete
                </button>
                <button onclick="toggleComments({{ discussion.id }})"
                    style="background-color: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">
                    View Comments
                </button>
            </td>
        </tr>
        <tr id="comments-{{ discussion.id }}" style="display: none; background-color: #f9f9f9;">
            <td colspan="7" style="padding: 10px; border: 1px solid #ddd;">
                <strong>Comments:</strong>
                {% if discussion.comments %}
                <ul style="list-style-type: none; padding: 0;">
                    {% for comment in discussion.comments %}
                    <li id="comment-{{ comment.id }}">
                        <div id="comment-display-{{ comment.id }}">
                            <strong>{{ comment.commenter }}</strong>: {{ comment.comment }}
                            <small style="color: gray;">({{ comment.created_at }})</small>
                            <button onclick="openEditCommentForm({{ comment.id }}, {{ comment.comment|tojson }})">Edit</button>
                        </div>
                        <form id="comment-edit-form-{{ comment.id }}" style="display: none;"
                            onsubmit="updateComment(event, {{ discussion.id }}, {{ comment.id }})">
                            <input type="text" name="comment" value="{{ comment.comment }}" required>
                            <button type="submit">Save</button>
                            <button type="button" onclick="cancelEditComment({{ comment.id }})">Cancel</button>
                        </form>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p>No comments yet.</p>
                {% endif %}
                <!-- Add Comment Form -->
                <form onsubmit="addComment(event, {{ discussion.id }})" style="margin-top: 10px;">
                    <input type="text" name="comment" placeholder="Add a comment..." required
                        style="width: 80%; padding: 8px; margin-right: 10px; border: 1px solid #ccc; border-radius: 5px;">
                    <button type="submit"
                        style="background-color: #4CAF50; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">
                        Post
                    </button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Modal -->
<div id="modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5);">
    <div style="background: white; margin: 50px auto; padding: 20px; width: 50%; border-radius: 5px;">
        <h2 id="modal-title"></h2>
        <form id="modal-form" onsubmit="handleSubmit(event)">
            <label for="title" style="display: block; margin-bottom: 5px; font-weight: bold;">Title:</label>
            <input type="text" name="title" id="title" required
                style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px;">
            <label for="content" style="display: block; margin-bottom: 5px; font-weight: bold;">Content:</label>
            <textarea name="content" id="content" required
                style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px;"></textarea>
            <input type="hidden" name="id" id="discussion-id">
            <label for="user_id" style="display: block; margin-bottom: 5px; font-weight: bold;">User ID:</label>
            <input type="number" name="user_id" id="user_id" required
                style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px;">
            <label for="user_apk_id" style="display: block; margin-bottom: 5px; font-weight: bold;">User APK ID:</label>
            <input type="number" name="user_apk_id" id="user_apk_id" required
                style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px;">
            <button type="submit"
                style="background-color: #4CAF50; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer;">
                Save
            </button>
            <button type="button" onclick="closeModal()"
                style="margin-left: 10px; background-color: #f44336; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer;">
                Cancel
            </button>
        </form>
    </div>
</div>

<script>
    function openModal(action, id = null, title = '', content = '') {
        const modal = document.getElementById('modal');
        const form = document.getElementById('modal-form');
        const modalTitle = document.getElementById('modal-title');
        const userId = document.getElementById('user_id');
        const userApkId = document.getElementById('user_apk_id');

        modal.style.display = 'block';

        if (action === 'add') {
            modalTitle.textContent = 'Add New Discussion';
            form.dataset.action = 'add';
            form.dataset.id = '';
            document.getElementById('title').value = '';
            document.getElementById('content').value = '';
            userId.value = '';
            userApkId.value = '';
        } else if (action === 'edit') {
            modalTitle.textContent = 'Edit Discussion';
            form.dataset.action = 'edit';
            form.dataset.id = id;
            document.getElementById('title').value = title;
            document.getElementById('content').value = content;
        }
    }

    function closeModal() {
        document.getElementById('modal').style.display = 'none';
    }

    async function handleSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const action = form.dataset.action;
        const id = form.dataset.id;

        const data = {
            title: document.getElementById('title').value,
            content: document.getElementById('content').value,
            user_id: document.getElementById('user_id').value,
            user_apk_id: document.getElementById('user_apk_id').value,
        };

        const url = action === 'add'
            ? "{{ url_for('diskusi.add_discussion') }}"
            : `{{ url_for('diskusi.update_discussion', discussion_id=0) }}`.replace('0', id);

        const method = action === 'add' ? 'POST' : 'PUT';

        try {
            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });

            if (response.ok) {
                alert('Success!');
                window.location.reload();
            } else {
                const error = await response.json();
                alert(error.message || 'Failed to process the request.');
            }
        } catch (error) {
            alert('Unexpected error: ' + error);
        }
    }

    async function handleDelete(id) {
        if (!confirm('Are you sure you want to delete this discussion?')) return;

        try {
            const response = await fetch(`{{ url_for('diskusi.delete_discussion', discussion_id=0) }}`.replace('0', id), {
                method: 'DELETE',
            });

            if (response.ok) {
                alert('Deleted successfully.');
                window.location.reload();
            } else {
                alert('Failed to delete discussion.');
            }
        } catch (error) {
            alert('Unexpected error: ' + error);
        }
    }

    async function addComment(event, discussionId) {
        event.preventDefault();
        const form = event.target;
        const commentInput = form.querySelector('input[name="comment"]');

        const data = {
            comment: commentInput.value,
            user_apk_id: 1, // Adjust with the current logged-in user's ID
        };

        try {
            const response = await fetch(`/discussions/${discussionId}/comments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });

            if (response.ok) {
                alert('Comment added!');
                window.location.reload();
            } else {
                const error = await response.json();
                alert(error.message || 'Failed to add comment.');
            }
        } catch (error) {
            alert('Unexpected error: ' + error);
        }
    }

    function toggleComments(discussionId) {
        const commentsRow = document.getElementById(`comments-${discussionId}`);
        if (commentsRow.style.display === 'none') {
            commentsRow.style.display = 'table-row';
        } else {
            commentsRow.style.display = 'none';
        }
    }

    function openEditCommentForm(commentId, currentComment) {
        document.getElementById(`comment-display-${commentId}`).style.display = 'none';
        document.getElementById(`comment-edit-form-${commentId}`).style.display = 'block';
    }

    function cancelEditComment(commentId) {
        document.getElementById(`comment-display-${commentId}`).style.display = 'block';
        document.getElementById(`comment-edit-form-${commentId}`).style.display = 'none';
    }

    async function updateComment(event, discussionId, commentId) {
        event.preventDefault();
        const form = event.target;
        const commentInput = form.querySelector('input[name="comment"]');

        const data = { comment: commentInput.value };

        try {
            const response = await fetch(`/discussions/${discussionId}/comments/${commentId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });

            if (response.ok) {
                alert('Comment updated!');
                window.location.reload();
            } else {
                const error = await response.json();
                alert(error.message || 'Failed to update comment.');
            }
        } catch (error) {
            alert('Unexpected error: ' + error);
        }
    }
</script>
{% endblock %}
